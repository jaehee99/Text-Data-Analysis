---
title: "STAT 413/613 Homework: Tidy Text"
author: "Jaehee Lee"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: no
    toc_depth: 4
    number_sections: yes
    theme: cerulean
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(fig.align  = "center",
                      fig.height = 5, 
                      fig.width  = 6)
```

# Instructions {-}
1. Clone this homework repo to your homework directory as a new repo.
2. Rename the starter file under the analysis directory as `hw_01_yourname.Rmd` and use it for your solutions.   
3. Modify the "author" field in the YAML header.  
4. Stage and Commit R Markdown and HTML files (no PDF files).   
5. **Push both .Rmd and HTML files to GitHub**.   
- Make sure you have knitted to HTML prior to staging, committing, and pushing your final submission.  
6. **Commit each time you answer a part of question, e.g. 1.1**   
7. **Push to GitHub after each major question**   
8. When complete, submit a response in Canvas  

- Only include necessary code to answer the questions.
- Most of the functions you use should be from the tidyverse. 
- Unnecessary Base R or other packages not covered in class will result in point deductions.
- Use Pull requests and or email to ask me any questions. If you email, please ensure your most recent code is pushed to GitHub.


# Sentiment Analysis

Load library
```{r}
library(tidyverse)
library(tidytext)
library(stringr)
```

1. Download the following two works from the early 20^th^ century from Project Gutenberg:
- Upton Sinclair: "*The Jungle*" (1906)
- W.E.B. Du Bois: "*The Quest of the Silver Fleece*" (1911)
```{r}
library(gutenbergr)
```

```{r}
# Upton Sinclair: "*The Jungle*" (1906)
gutenberg_works() %>%  
  filter(title == "The Jungle") %>%  
  select(gutenberg_id) -> jungle_id
gutenberg_download(jungle_id) -> jungle
```

```{r}
# W.E.B. Du Bois: "*The Quest of the Silver Fleece*" (1911)
gutenberg_works() %>%  
  filter(title == "The Quest of the Silver Fleece: A Novel")  %>% 
  select(gutenberg_id) -> silver_id
gutenberg_download(silver_id) -> silver
```

2. Write a function `to take an argument of a downloaded book tibble and return it in tidy text format.
- The function must add line and chapter numbers as variables
- The function must unnest tokens at the word level
- The function must remove any Project Gutenberg formatting so only the words remain
- The function must remove any stop_words and filter out any `NA`s
- The function must remove any front matter (words before Chapter 1)
- The function can consider the unique nature of the front matter but cannot consider exactly how many chapters are in each book based on looking at the data i.e., no math based on knowing the number of chapters.
```{r}
jungle_function <- function(jungle){
  jungle %>%  
  mutate(linenumber = row_number()) %>%  
  mutate(chapter = cumsum(str_detect(text, regex("^CHAPTER [\\divxlc]",ignore_case = TRUE)))) %>%  
     ungroup() %>% 
  select(chapter, linenumber, everything()) -> jungle
  jungle <- jungle[-(1:51), , drop = FALSE]
  
  jungle%>% 
    unnest_tokens(word,text) %>%
    mutate(word = str_extract(word, "[a-z']+")) %>%
    anti_join(stop_words, by = "word") %>%  
  drop_na() -> jungle_jungle
  return(jungle_jungle)
}
# jungle_function(jungle)
```

```{r}
silver_function <- function(silver){
silver %>%  
  mutate(linenumber = row_number()) %>%  
  mutate(chapter = cumsum(str_detect(text, regex("(^_)([a-z]+)([-]{0,1})([a-z]+)(_$)",ignore_case = TRUE))))  %>%  
    ungroup() %>% 
  select(chapter, linenumber, everything())-> silver 
silver <- silver[-(1:143), , drop = FALSE]

silver %>%  
  unnest_tokens(word,text) %>% 
    mutate(word = str_extract(word, "[a-z']+")) %>% 
   anti_join(stop_words, by = "word") %>%  
  drop_na()  -> silver_silver
return(silver_silver)
}
# silver_function(silver)
```

3. Use the function from step 2
- Tidy each book and then add `book` and `author` as variables and save each tibble to a new variable. How many rows are in each book?
```{r}
jungle_function(jungle) %>%   
  mutate(author = "Upton Sinclair") %>%  
  mutate(book = "The Jungle") -> new_jungle
nrow(new_jungle)
```
```{r}
silver_function(silver) %>%  
 mutate(author = "W.E.B. Du Bois") %>%  
  mutate(book = "The Quest of the Silver Fleece: A Novel") -> new_silver
nrow(new_silver)
```

4. Use a dplyr function to combine the two tibbles into a new tibble. 
- It should have 89,434 rows with 6 variables
```{r}
bind_rows(mutate(new_jungle, author = "Upton Sinclair"), 
          mutate(new_silver, author = "W.E.B. Du Bois")) -> jungle_silver
nrow(jungle_silver)
```

5. Measure the net sentiment using bing for each block of 50 lines
- Plot the sentiment for each book in an appropriate faceted plot - either line or column. 
- Be sure to remove the legend.
- Save the plot to a variable
- Interpret the plots for each book and compare them.
```{r}
jungle_silver %>%  
  inner_join(get_sentiments("bing")) %>%  
  count(book, index = linenumber %/% 50, sentiment) %>%  
  spread(sentiment, n, fill = 0) %>%  
  mutate(sentiment = positive - negative) %>%  
  ggplot(aes(index, sentiment, fill = book)) +
  geom_col(show.legend = FALSE) +
  facet_wrap(~book, ncol = 2, scales = "free_x") -> compare_sentiment

compare_sentiment
```
Interpretation: Both of the books have significantly more negative sentiments compared to positive sentiments. This is because most of the lines are below 0. However, when we compare two graphs, it seems like "The Quest of the Silver Fleece" have more positive words than "the Jungle".

6. Measure the total for each nrc sentiment in each block of 500 lines and then,
- Filter out the "positive" and "negative" and save to a new variable. You should have 464 observations.
- Plot the count of the sentiments for each block in each book in an appropriate faceted plot with the books in two columns and the sentiments in 8 rows. 
- Be sure to remove the legend.
- Interpret the plots for each book and then compare them. 
- Why did the values drop off so suddenly at the end?
```{r}
get_sentiments("nrc") %>%  
  filter(sentiment != "positive" & sentiment != "negative") -> removed_data

jungle_silver %>%  
       inner_join(removed_data, by = "word") %>%  
      count(book, index = linenumber %/% 500, sentiment) -> observations
observations %>%  
  ggplot(aes(index, n, fill = sentiment)) + 
  geom_col(show.legend = FALSE) +
  facet_wrap(~book,scales = "free_y") 
```

